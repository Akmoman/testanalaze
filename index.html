<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</title>
    
    <!-- ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Tailwind CSS Ù„Ù„ØªØµÙ…ÙŠÙ… -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 1. ØªØ­Ù…ÙŠÙ„ React Ùˆ ReactDOM (Ù†Ø³Ø® Ù…Ø³ØªÙ‚Ø±Ø©) -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- 2. ØªØ­Ù…ÙŠÙ„ Prop-types (Ù…Ù‡Ù… Ù„Ø¹Ù…Ù„ Recharts ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­) -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    
    <!-- 3. ØªØ­Ù…ÙŠÙ„ Recharts (Ù†Ø³Ø®Ø© Ù…Ø­Ø¯Ø¯Ø© ØªØ¹Ù…Ù„ Ø¨Ø«Ø¨Ø§Øª) -->
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    
    <!-- 4. ØªØ­Ù…ÙŠÙ„ Babel Ù„ØªØ±Ø¬Ù…Ø© ÙƒÙˆØ¯ React -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap');
        
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f8fafc;
        }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        @media print {
            @page { margin: 0.5cm; size: A4; }
            body { 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact; 
                background: white; 
            }
            .no-print { display: none !important; }
            .print-break-avoid { break-inside: avoid; page-break-inside: avoid; }
            header, button, input[type="text"], select { display: none !important; }
            h1 { display: block !important; }
            .no-print-container { display: none !important; }
            /* Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø¸Ù‡ÙˆØ± Ø¨Ø­Ø¬Ù… Ù…Ù†Ø§Ø³Ø¨ */
            .recharts-responsive-container { height: 350px !important; width: 100% !important; }
            .print-full-width { width: 100% !important; max-width: none !important; }
            .shadow-sm, .shadow-lg { box-shadow: none !important; }
            .bg-slate-50 { background-color: #f8fafc !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Recharts
        const RechartsLib = window.Recharts || {};
        const { 
            BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, AreaChart, Area, PieChart, Pie, Cell, ReferenceLine 
        } = RechartsLib;

        // --- Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª SVG (Ø¨Ø¯ÙŠÙ„ Ù„Ù€ Lucide-React Ù„ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¨Ù†Ø§Ø¡) ---
        const Icons = {
            Table: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3v18"/><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M3 15h18"/></svg>,
            RefreshCw: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
            Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Calculator: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
            FileText: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>,
            Printer: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><path d="M6 14h12v8H6z"/></svg>,
            TrendingUp: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>,
            Activity: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>,
            Award: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/></svg>,
            Sigma: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 7V4H6l6 8-6 8h12v-3"/></svg>,
            AlertTriangle: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>,
            CheckCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            ArrowDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 5v14"/><path d="m19 12-7 7-7-7"/></svg>,
            ArrowUp: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 19V5"/><path d="m5 12 7-7 7 7"/></svg>,
            PenLine: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
        };

        // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ---
        const STUDENTS_COUNT = 35;
        const QUESTIONS_COUNT = 60; 

        // --- Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ---
        const getGradeLevel = (score, totalScore) => {
            if (totalScore === 0) return { label: '-', color: 'bg-slate-100 text-slate-500', chartColor: '#cbd5e1' };
            
            const percentage = (score / totalScore) * 100;
            if (percentage >= 87.5) return { label: 'Ù…Ù…ØªØ§Ø²', color: 'bg-emerald-100 text-emerald-700', chartColor: '#10B981' };
            if (percentage >= 75) return { label: 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹', color: 'bg-blue-100 text-blue-700', chartColor: '#3B82F6' };
            if (percentage >= 62.5) return { label: 'Ø¬ÙŠØ¯', color: 'bg-indigo-100 text-indigo-700', chartColor: '#6366F1' };
            if (percentage >= 50) return { label: 'Ù…Ù‚Ø¨ÙˆÙ„', color: 'bg-yellow-100 text-yellow-700', chartColor: '#F59E0B' };
            return { label: 'Ø±Ø§Ø³Ø¨', color: 'bg-red-100 text-red-700', chartColor: '#EF4444' };
        };

        // --- Ø¯ÙˆØ§Ù„ Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ù…Ø³Ø§Ø¹Ø¯Ø© ---
        const calculateMedian = (values) => {
            if (values.length === 0) return 0;
            const sorted = [...values].sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            return sorted.length % 2 !== 0 ? sorted[mid] : ((sorted[mid - 1] + sorted[mid]) / 2);
        };

        const calculateMode = (values) => {
            if (values.length === 0) return 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
            const frequency = {};
            let maxFreq = 0;
            let modes = [];
            values.forEach(v => {
                frequency[v] = (frequency[v] || 0) + 1;
                if (frequency[v] > maxFreq) maxFreq = frequency[v];
            });
            if (maxFreq === 1) return 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
            for (const key in frequency) {
                if (frequency[key] === maxFreq) modes.push(key);
            }
            return modes.length > 3 ? 'Ù…ØªØ¹Ø¯Ø¯' : modes.join(', ');
        };

        const calculateStdDev = (values, mean) => {
            if (values.length === 0) return 0;
            const squareDiffs = values.map(value => Math.pow(value - mean, 2));
            const avgSquareDiff = squareDiffs.reduce((a, b) => a + b, 0) / values.length;
            return Math.sqrt(avgSquareDiff).toFixed(2);
        };

        // --- ØªÙˆÙ„ÙŠØ¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ© ---
        const initialData = Array.from({ length: STUDENTS_COUNT }, (_, i) => {
            const student = { id: i + 1, name: `Ø·Ø§Ù„Ø¨ ${i + 1}` };
            for (let q = 1; q <= QUESTIONS_COUNT; q++) {
                student[`q${q}`] = 0;
            }
            return student;
        });

        // ØªÙˆØ²ÙŠØ¹ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø¯Ø±Ø¬Ø§Øª
        const initialMaxScores = Array(QUESTIONS_COUNT).fill(1); 

        // --- Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª ---

        const StatCard = ({ title, value, subtext, color, icon: Icon }) => (
            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 print-break-avoid">
                <div className="flex justify-between items-start">
                    <div>
                        <p className="text-sm font-medium text-slate-500">{title}</p>
                        <h3 className="text-2xl font-bold text-slate-800 mt-1">{value}</h3>
                    </div>
                    <div className={`p-2 rounded-lg ${color} text-white print:text-black print:bg-transparent`}>
                        <Icon />
                    </div>
                </div>
                {subtext && <p className="text-xs text-slate-400 mt-2">{subtext}</p>}
            </div>
        );

        const DataEntryView = ({ data, maxScores, onUpdateData, onUpdateMaxScore, onRandomize, onReset, totalScore, examTitle, setExamTitle }) => {
            
            const handleScoreChange = (studentId, questionIndex, value) => {
                const qKey = `q${questionIndex + 1}`;
                const maxScore = maxScores[questionIndex];
                if (maxScore === 0) return;

                if (maxScore === 1) {
                    if (value === '') {
                        onUpdateData(studentId, qKey, 0); 
                        return;
                    }
                    if (value !== '0' && value !== '1') return;
                    onUpdateData(studentId, qKey, parseInt(value));
                } else {
                    const parsedVal = parseFloat(value);
                    const newValue = isNaN(parsedVal) ? 0 : Math.min(Math.max(0, parsedVal), maxScore);
                    onUpdateData(studentId, qKey, newValue);
                }
            };

            const handleMaxScoreChange = (index, value) => {
                const newValue = Math.max(0, parseFloat(value) || 0);
                onUpdateMaxScore(index, newValue);
            };

            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col h-[calc(100vh-220px)] animate-fade-in no-print-container">
                    <div className="p-4 border-b border-slate-200 flex flex-col md:flex-row justify-between items-start md:items-center bg-slate-50 rounded-t-xl gap-4 no-print">
                        <div className="flex-1">
                            <div className="flex items-center gap-2 mb-1 group">
                                <input 
                                    type="text" 
                                    value={examTitle}
                                    onChange={(e) => setExamTitle(e.target.value)}
                                    className="font-bold text-slate-800 text-lg border-b border-dashed border-transparent hover:border-blue-400 focus:border-blue-600 focus:outline-none bg-transparent transition-colors w-full md:w-auto"
                                    placeholder="Ø§Ù†Ù‚Ø± Ù‡Ù†Ø§ Ù„ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø£Ùˆ Ø§Ù„ØµÙ..."
                                />
                                <Icons.PenLine className="w-4 h-4 text-slate-400 opacity-0 group-hover:opacity-100 transition-opacity" />
                            </div>
                            <p className="text-xs text-slate-500 flex items-center gap-1">
                                <Icons.Table />
                                Ø¬Ø¯ÙˆÙ„ Ø±ØµØ¯ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª (Ù…ÙØ±Ø¯Ø§Øª) - Ù‚Ù… Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø¹Ø¸Ù…Ù‰ ÙÙŠ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„.
                            </p>
                        </div>
                        
                        <div className="flex flex-wrap items-center gap-3">
                            <div className="bg-blue-100 text-blue-800 px-3 py-1.5 rounded-lg text-sm font-bold border border-blue-200 whitespace-nowrap">
                                Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: {totalScore}
                            </div>
                            
                            <button 
                                onClick={onReset}
                                className="flex items-center gap-2 px-3 py-1.5 text-sm text-red-600 bg-red-50 border border-red-100 hover:bg-red-100 hover:border-red-200 rounded-lg transition-colors whitespace-nowrap"
                                title="Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨"
                            >
                                <Icons.Trash2 />
                                ØªØµÙÙŠØ± Ø§Ù„Ø¬Ø¯ÙˆÙ„
                            </button>

                            <button 
                                onClick={onRandomize}
                                className="flex items-center gap-2 px-3 py-1.5 text-sm text-blue-600 bg-white border border-blue-200 hover:bg-blue-50 rounded-lg transition-colors whitespace-nowrap"
                            >
                                <Icons.RefreshCw />
                                Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©
                            </button>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-auto">
                        <table className="w-full text-center border-collapse">
                            <thead className="bg-slate-100 sticky top-0 z-20 shadow-sm">
                                <tr>
                                    <th rowSpan="2" className="p-3 text-xs font-bold text-slate-600 border-b border-r bg-slate-100 min-w-[50px] z-20 sticky right-0">#</th>
                                    <th rowSpan="2" className="p-3 text-xs font-bold text-slate-600 border-b min-w-[140px] text-right bg-slate-100 z-20 sticky right-[50px]">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    {Array.from({ length: QUESTIONS_COUNT }, (_, i) => (
                                        <th key={i} className={`p-2 text-xs font-bold border-b border-l min-w-[60px] ${maxScores[i] === 0 ? 'bg-slate-200 text-slate-400' : 'bg-blue-50/50 text-blue-700'}`}>
                                            Ù…{i + 1}
                                        </th>
                                    ))}
                                    <th rowSpan="2" className="p-3 text-xs font-bold text-emerald-700 border-b min-w-[80px] bg-emerald-50">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
                                    <th rowSpan="2" className="p-3 text-xs font-bold text-purple-700 border-b min-w-[90px] bg-purple-50">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</th>
                                </tr>
                                <tr>
                                    {maxScores.map((score, i) => (
                                        <th key={i} className={`p-1 border-b border-l ${score === 0 ? 'bg-slate-200' : 'bg-blue-100/50'}`}>
                                            <div className="flex flex-col items-center gap-1">
                                                <span className={`text-[10px] ${score === 0 ? 'text-slate-400' : 'text-slate-500'}`}>Ù…Ù†</span>
                                                <input 
                                                    type="number" 
                                                    min="0"
                                                    value={score}
                                                    onChange={(e) => handleMaxScoreChange(i, e.target.value)}
                                                    className={`w-10 text-center text-xs font-bold rounded px-1 py-0.5 outline-none border ${score === 0 ? 'bg-slate-100 text-slate-400 border-slate-300' : 'bg-white text-blue-800 border-blue-200 focus:ring-2 focus:ring-blue-400'}`}
                                                />
                                            </div>
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {data.map((student) => {
                                    const total = Array.from({ length: QUESTIONS_COUNT }, (_, i) => student[`q${i + 1}`]).reduce((a, b) => a + b, 0);
                                    const roundedTotal = Math.round(total * 100) / 100;
                                    const level = getGradeLevel(roundedTotal, totalScore);

                                    return (
                                        <tr key={student.id} className="hover:bg-slate-50 transition-colors group">
                                            <td className="p-2 text-xs font-mono text-slate-400 border-l border-slate-100 bg-slate-50 sticky right-0 z-10">{student.id}</td>
                                            <td className="p-2 text-sm font-medium text-slate-700 text-right border-l border-slate-100 bg-white sticky right-[50px] z-10">{student.name}</td>
                                            {Array.from({ length: QUESTIONS_COUNT }, (_, i) => {
                                                const isDisabled = maxScores[i] === 0;
                                                return (
                                                    <td key={i} className={`p-1 border-l border-slate-100 ${isDisabled ? 'bg-slate-50' : ''}`}>
                                                        <input
                                                            type="text"
                                                            inputMode={maxScores[i] === 1 ? "numeric" : "decimal"}
                                                            disabled={isDisabled}
                                                            value={student[`q${i + 1}`] === 0 ? '' : student[`q${i + 1}`]}
                                                            placeholder={isDisabled ? '-' : '0'}
                                                            onChange={(e) => handleScoreChange(student.id, i, e.target.value)}
                                                            className={`w-full text-center p-1 rounded outline-none text-sm font-bold transition-all ${
                                                                isDisabled ? 'bg-transparent text-slate-300 cursor-not-allowed' :
                                                                student[`q${i + 1}`] === maxScores[i] ? 'text-green-600 bg-green-50 focus:ring-2 focus:ring-green-400' :
                                                                student[`q${i + 1}`] === 0 ? 'text-slate-300 focus:ring-2 focus:ring-blue-500' : 'text-slate-700 bg-blue-50/10 focus:ring-2 focus:ring-blue-500'
                                                            }`}
                                                        />
                                                    </td>
                                                );
                                            })}
                                            <td className={`p-2 font-bold bg-emerald-50/30 ${roundedTotal > totalScore ? 'text-red-600' : 'text-emerald-700'}`}>
                                                {roundedTotal}
                                            </td>
                                            <td className="p-2 border-r border-slate-100">
                                                <span className={`px-2 py-1 rounded text-xs font-bold ${level.color}`}>
                                                    {level.label}
                                                </span>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const AnalysisDashboard = ({ data, maxScores, totalScore, examTitle }) => {
            const stats = useMemo(() => {
                const studentTotals = data.map(s => {
                    const total = Array.from({ length: QUESTIONS_COUNT }, (_, i) => s[`q${i + 1}`]).reduce((a, b) => a + b, 0);
                    return {
                        name: s.name,
                        total: Math.round(total * 100) / 100,
                        level: getGradeLevel(total, totalScore)
                    };
                });
                
                const allTotals = studentTotals.map(s => s.total);
                const avgTotal = parseFloat((allTotals.reduce((a, b) => a + b, 0) / STUDENTS_COUNT).toFixed(2));
                const maxScore = Math.max(...allTotals);
                const minScore = Math.min(...allTotals);
                const passScore = totalScore * 0.5;
                const passCount = studentTotals.filter(s => s.total >= passScore).length;
                const passRate = ((passCount / STUDENTS_COUNT) * 100).toFixed(1);

                const median = calculateMedian(allTotals);
                const mode = calculateMode(allTotals);
                const stdDev = calculateStdDev(allTotals, avgTotal);

                const questionsAnalysis = Array.from({ length: QUESTIONS_COUNT }, (_, i) => {
                    const qKey = `q${i + 1}`;
                    const qMaxScore = maxScores[i];
                    
                    if (qMaxScore === 0) {
                        return {
                            question: `Ù…${i + 1}`,
                            maxScore: 0,
                            sum: 0,
                            ease: 0,
                            difficulty: 0,
                            status: 'Ù…Ø³ØªØ¨Ø¹Ø¯'
                        };
                    }

                    const scores = data.map(s => s[qKey]);
                    const sum = scores.reduce((a, b) => a + b, 0);
                    
                    const easeIndex = sum / (STUDENTS_COUNT * qMaxScore);
                    const diffIndex = 1 - easeIndex;
                    
                    let status = 'Ù…ØªÙˆØ³Ø·';
                    if (easeIndex > 0.8) status = 'Ø³Ù‡Ù„ Ø¬Ø¯Ø§Ù‹';
                    else if (easeIndex > 0.6) status = 'Ø³Ù‡Ù„';
                    else if (easeIndex < 0.25) status = 'ØµØ¹Ø¨ Ø¬Ø¯Ø§Ù‹';
                    else if (easeIndex < 0.45) status = 'ØµØ¹Ø¨';

                    return {
                        question: `Ù…${i + 1}`,
                        maxScore: qMaxScore,
                        sum: Math.round(sum * 10) / 10,
                        ease: parseFloat(easeIndex.toFixed(2)),
                        difficulty: parseFloat(diffIndex.toFixed(2)),
                        status
                    };
                });

                const activeQuestions = questionsAnalysis.filter(q => q.status !== 'Ù…Ø³ØªØ¨Ø¹Ø¯');
                const weaknesses = activeQuestions.filter(q => q.ease < 0.45);
                const strengths = activeQuestions.filter(q => q.ease > 0.75);

                const hardestQuestions = [...activeQuestions].sort((a, b) => a.ease - b.ease).slice(0, 10);
                const easiestQuestions = [...activeQuestions].sort((a, b) => b.ease - a.ease).slice(0, 10);

                const levelCounts = { 'Ù…Ù…ØªØ§Ø²': 0, 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹': 0, 'Ø¬ÙŠØ¯': 0, 'Ù…Ù‚Ø¨ÙˆÙ„': 0, 'Ø±Ø§Ø³Ø¨': 0 };
                studentTotals.forEach(s => levelCounts[s.level.label]++);
                
                const levelData = Object.keys(levelCounts).map(key => ({
                    name: key,
                    value: levelCounts[key],
                    color: getGradeLevel(
                        key === 'Ù…Ù…ØªØ§Ø²' ? totalScore * 0.9 : 
                        key === 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹' ? totalScore * 0.8 : 
                        key === 'Ø¬ÙŠØ¯' ? totalScore * 0.65 : 
                        key === 'Ù…Ù‚Ø¨ÙˆÙ„' ? totalScore * 0.55 : 0, 
                        totalScore
                    ).chartColor
                })).filter(item => item.value > 0);

                const binSize = totalScore / 5;
                const frequencyData = Array.from({ length: 5 }, (_, i) => {
                    const rangeStart = Math.round(i * binSize);
                    const rangeEnd = Math.round((i + 1) * binSize);
                    const count = allTotals.filter(t => t >= rangeStart && (i === 4 ? t <= rangeEnd : t < rangeEnd)).length;
                    return {
                        range: `${rangeStart} - ${rangeEnd}`,
                        count
                    };
                });

                return { 
                    studentTotals, questionsAnalysis, weaknesses, strengths,
                    avgTotal, passRate, levelData, minScore, maxScore,
                    median, mode, stdDev, frequencyData, hardestQuestions, easiestQuestions 
                };
            }, [data, totalScore, maxScores]);

            const generateReportText = () => {
                let text = `## ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„: ${examTitle}\n\n`;

                text += `### 1ï¸âƒ£ Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¯Ø§Ø¡:\n`;
                text += `- **Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨:** ${STUDENTS_COUNT} Ø·Ø§Ù„Ø¨.\n`;
                text += `- **Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­:** ${stats.passRate}%.\n`;
                text += `- **Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠ:** ${stats.avgTotal} Ù…Ù† ${totalScore}.\n`;
                
                let performance = "";
                if (stats.passRate >= 90) performance = "Ù…Ù…ØªØ§Ø²";
                else if (stats.passRate >= 75) performance = "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹";
                else if (stats.passRate >= 60) performance = "Ø¬ÙŠØ¯";
                else if (stats.passRate >= 50) performance = "Ù…Ù‚Ø¨ÙˆÙ„";
                else performance = "Ø¶Ø¹ÙŠÙ - ÙŠØ­ØªØ§Ø¬ Ù„ØªØ¯Ø®Ù„ Ø¹Ø§Ø¬Ù„";
                text += `- **Ø§Ù„ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ø¯ÙØ¹Ø©:** ${performance}.\n\n`;

                text += `### 2ï¸âƒ£ ØªØ­Ù„ÙŠÙ„ ØªØ¬Ø§Ù†Ø³ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Ø§Ù„ØªØ´ØªØª):\n`;
                text += `- **Ø§Ù„Ù…Ø¯Ù‰:** ØªÙØ§ÙˆØªØª Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø¨ÙŠÙ† Ø£Ø¯Ù†Ù‰ Ø¯Ø±Ø¬Ø© **(${stats.minScore})** ÙˆØ£Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø© **(${stats.maxScore})**.\n`;
                text += `- **Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù Ø§Ù„Ù…Ø¹ÙŠØ§Ø±ÙŠ:** (${stats.stdDev}). `;
                
                const stdDevRatio = stats.stdDev / totalScore;
                if (stdDevRatio < 0.15) {
                    text += "ÙˆÙ‡Ùˆ Ù…Ø¤Ø´Ø± Ù…Ù†Ø®ÙØ¶ØŒ ÙŠØ¯Ù„ Ø¹Ù„Ù‰ Ø£Ù† Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ **Ù…ØªÙ‚Ø§Ø±Ø¨Ø© Ø¬Ø¯Ø§Ù‹ (Ù…ØªØ¬Ø§Ù†Ø³Ø©)**.\n";
                } else if (stdDevRatio > 0.25) {
                    text += "ÙˆÙ‡Ùˆ Ù…Ø¤Ø´Ø± Ù…Ø±ØªÙØ¹ØŒ ÙŠØ¯Ù„ Ø¹Ù„Ù‰ ÙˆØ¬ÙˆØ¯ **ÙØ¬ÙˆØ© ÙƒØ¨ÙŠØ±Ø©** ÙˆØªÙØ§ÙˆØª Ø­Ø§Ø¯ Ø¨ÙŠÙ† Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ (Ù…Ø¬Ù…ÙˆØ¹Ø© ØºÙŠØ± Ù…ØªØ¬Ø§Ù†Ø³Ø©).\n";
                } else {
                    text += "ÙˆÙ‡Ùˆ Ù…Ø¤Ø´Ø± Ù…ØªÙˆØ³Ø·ØŒ ÙŠØ¯Ù„ Ø¹Ù„Ù‰ ØªØ¨Ø§ÙŠÙ† Ø·Ø¨ÙŠØ¹ÙŠ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª.\n";
                }
                text += "\n";

                text += `### 3ï¸âƒ£ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙØ±Ø¯Ø§Øª (Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ© ÙˆØ§Ù„Ø¶Ø¹Ù):\n`;
                
                const veryHard = stats.questionsAnalysis.filter(q => q.ease < 0.3 && q.status !== 'Ù…Ø³ØªØ¨Ø¹Ø¯');
                const hard = stats.questionsAnalysis.filter(q => q.ease >= 0.3 && q.ease < 0.5 && q.status !== 'Ù…Ø³ØªØ¨Ø¹Ø¯');
                const moderate = stats.questionsAnalysis.filter(q => q.ease >= 0.5 && q.ease < 0.75 && q.status !== 'Ù…Ø³ØªØ¨Ø¹Ø¯');
                const easy = stats.questionsAnalysis.filter(q => q.ease >= 0.75 && q.status !== 'Ù…Ø³ØªØ¨Ø¹Ø¯');

                if (veryHard.length > 0) {
                    text += `- ğŸ”´ **Ù…ÙØ±Ø¯Ø§Øª Ø´Ø¯ÙŠØ¯Ø© Ø§Ù„ØµØ¹ÙˆØ¨Ø© (Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© < 30%):** \n  (${veryHard.map(q => q.question).join('ØŒ ')}). \n  *Ø§Ù„ØªØ­Ù„ÙŠÙ„:* Ù‚Ø¯ ØªÙƒÙˆÙ† Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØºØ§Ù…Ø¶Ø©ØŒ Ø£Ùˆ ØªÙ‚ÙŠØ³ Ù…Ù‡Ø§Ø±Ø© Ù„Ù… ÙŠØªÙ… ØªØ¯Ø±ÙŠØ³Ù‡Ø§ Ø¨Ø¹Ù…Ù‚ØŒ Ø£Ùˆ ØªÙÙˆÙ‚ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø·Ù„Ø§Ø¨.\n`;
                }
                if (hard.length > 0) {
                    text += `- ğŸŸ  **Ù…ÙØ±Ø¯Ø§Øª ØµØ¹Ø¨Ø©/ØªØ­Ø¯ÙŠ (30% - 50%):** \n  (${hard.map(q => q.question).join('ØŒ ')}). \n  *Ø§Ù„ØªØ­Ù„ÙŠÙ„:* Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØªÙ…ÙŠØ² Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ØªÙÙˆÙ‚ÙŠÙ†ØŒ Ù„ÙƒÙ† Ø´Ø±ÙŠØ­Ø© ÙƒØ¨ÙŠØ±Ø© ÙˆØ§Ø¬Ù‡Øª ØµØ¹ÙˆØ¨Ø© ÙÙŠÙ‡Ø§.\n`;
                }
                if (moderate.length > 0) {
                    text += `- ğŸŸ¡ **Ù…ÙØ±Ø¯Ø§Øª Ù…ØªÙˆØ³Ø·Ø© (50% - 75%):** \n  Ø¹Ø¯Ø¯Ù‡Ø§ ${moderate.length} Ù…ÙØ±Ø¯Ø©. ØªØ¹ÙƒØ³ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù…Ø¹Ø¸Ù… Ø§Ù„Ø·Ù„Ø§Ø¨.\n`;
                }
                if (easy.length > 0) {
                    text += `- ğŸŸ¢ **Ù…ÙØ±Ø¯Ø§Øª ØªÙ… Ø¥ØªÙ‚Ø§Ù†Ù‡Ø§ ( > 75%):** \n  (${easy.map(q => q.question).join('ØŒ ')}). \n  *Ø§Ù„ØªØ­Ù„ÙŠÙ„:* Ù…Ø¤Ø´Ø± Ø¥ÙŠØ¬Ø§Ø¨ÙŠ Ø¹Ù„Ù‰ Ø§Ø³ØªÙŠØ¹Ø§Ø¨ Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©.\n`;
                }
                text += "\n";

                text += `### 4ï¸âƒ£ Ø§Ù„ØªÙˆØµÙŠØ§Øª ÙˆØ§Ù„Ù…Ù‚ØªØ±Ø­Ø§Øª:\n`;
                if (stats.passRate < 50) {
                    text += `- âš ï¸ **Ø®Ø·Ø© Ø·ÙˆØ§Ø±Ø¦:** Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ù…ØªØ¯Ù†ÙŠØ©. ÙŠØ¬Ø¨ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø£Ø³Ø§Ù„ÙŠØ¨ Ø§Ù„ØªØ¯Ø±ÙŠØ³ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªÙ‚ÙŠÙŠÙ… Ù…Ù„Ø§Ø¡Ù…Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„Ù…Ù†Ù‡Ø¬.\n`;
                    text += `- ğŸ“š ØªÙ†ÙÙŠØ° Ø­ØµØµ ØªÙ‚ÙˆÙŠØ© Ø¥Ù„Ø²Ø§Ù…ÙŠØ© Ù„Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø±Ø§Ø³Ø¨ÙŠÙ† ØªØ±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª.\n`;
                } else if (veryHard.length > 3) {
                    text += `- ğŸ“ **Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ…:** ÙŠÙˆØµÙ‰ Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø´Ø±Ø­ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØµØ¹Ø¨Ø© (${veryHard.slice(0,3).map(q => q.question).join('ØŒ ')}) ÙˆØªÙˆØ¶ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©.\n`;
                }
                
                if (stdDevRatio > 0.25) {
                    text += `- ğŸ¤ **ØªÙ‚Ù„ÙŠØµ Ø§Ù„ÙØ¬ÙˆØ©:** ØªÙØ¹ÙŠÙ„ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© "Ø§Ù„ØªØ¹Ù„Ù… Ø¨Ø§Ù„Ø£Ù‚Ø±Ø§Ù†" (Peer Learning) Ø¨Ø¯Ù…Ø¬ Ø§Ù„Ù…ØªÙÙˆÙ‚ÙŠÙ† Ù…Ø¹ Ø§Ù„Ù…ØªØ¹Ø«Ø±ÙŠÙ† ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø¹Ù…Ù„.\n`;
                }
                
                text += `- ğŸŒŸ **Ø§Ù„ØªØ¹Ø²ÙŠØ²:** ØªÙƒØ±ÙŠÙ… Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø­Ø§ØµÙ„ÙŠÙ† Ø¹Ù„Ù‰ ØªÙ‚Ø¯ÙŠØ± Ù…Ù…ØªØ§Ø² (${stats.levelData.find(l => l.name === 'Ù…Ù…ØªØ§Ø²')?.value || 0} Ø·Ù„Ø§Ø¨) Ù„ØªØ­ÙÙŠØ² Ø§Ù„ØªÙ†Ø§ÙØ³ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ.\n`;

                return text;
            };

            return (
                <div className="space-y-6 animate-fade-in pb-10 print:space-y-4">
                    <div className="hidden print:block text-center mb-8 border-b-2 border-slate-800 pb-4">
                        <h1 className="text-3xl font-bold text-slate-900">{examTitle}</h1>
                        <p className="text-slate-600 mt-2">ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨</p>
                        <div className="flex justify-center gap-6 mt-4 text-sm text-slate-500">
                        <span>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨: {STUDENTS_COUNT}</span>
                        <span>Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ©: {totalScore}</span>
                        <span>Ø§Ù„ØªØ§Ø±ÙŠØ®: {new Date().toLocaleDateString('ar-EG')}</span>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 print:grid-cols-4">
                        <StatCard 
                            title="Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠ" 
                            value={stats.avgTotal} 
                            subtext={`Ù…Ù† Ø£ØµÙ„ ${totalScore}`}
                            icon={Icons.TrendingUp} 
                            color="bg-blue-500" 
                        />
                        <StatCard 
                            title="Ø§Ù„ÙˆØ³ÙŠØ· (Median)" 
                            value={stats.median} 
                            subtext="Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ØªÙˆØ³Ø·Ø©"
                            icon={Icons.Activity} 
                            color="bg-purple-500" 
                        />
                        <StatCard 
                            title="Ø§Ù„Ù…Ù†ÙˆØ§Ù„ (Mode)" 
                            value={stats.mode} 
                            subtext="Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø£ÙƒØ«Ø± ØªÙƒØ±Ø§Ø±Ø§Ù‹"
                            icon={Icons.Award} 
                            color="bg-pink-500" 
                        />
                        <StatCard 
                            title="Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù Ø§Ù„Ù…Ø¹ÙŠØ§Ø±ÙŠ" 
                            value={stats.stdDev} 
                            subtext="Ù…Ù‚ÙŠØ§Ø³ Ø§Ù„ØªØ´ØªØª"
                            icon={Icons.Sigma} 
                            color="bg-orange-500" 
                        />
                    </div>

                    <div className="bg-white p-8 rounded-xl shadow-sm border border-slate-200 border-r-4 border-r-blue-600 print:shadow-none print:border-slate-300 print:break-inside-avoid">
                        <div className="prose prose-slate max-w-none prose-p:my-1 prose-headings:mb-2 prose-headings:mt-4">
                        {generateReportText().split('\n').map((line, idx) => {
                            if (line.startsWith('## ')) return <h2 key={idx} className="text-2xl font-bold text-slate-900 pb-2 border-b">{line.replace('## ', '')}</h2>;
                            if (line.startsWith('### ')) return <h3 key={idx} className="text-lg font-bold text-blue-700 mt-4">{line.replace('### ', '')}</h3>;
                            if (line.startsWith('- ')) return <li key={idx} className="list-disc mr-4 text-slate-700">{line.replace('- ', '')}</li>;
                            return <p key={idx} className="text-slate-700 whitespace-pre-line">{line}</p>;
                        })}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 print:grid-cols-2 print:break-inside-avoid">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 print:shadow-none print:border-slate-300">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <Icons.ArrowDown />
                                Ø§Ù„Ù…ÙØ±Ø¯Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± ØµØ¹ÙˆØ¨Ø©
                                </h3>
                            </div>
                            <div className="overflow-auto max-h-64 print:max-h-none print:overflow-visible">
                                <table className="w-full text-center text-sm">
                                <thead className="bg-slate-50 text-slate-600">
                                    <tr>
                                    <th className="p-2 border-b">Ø§Ù„ØªØ±ØªÙŠØ¨</th>
                                    <th className="p-2 border-b">Ø§Ù„Ù…ÙØ±Ø¯Ø©</th>
                                    <th className="p-2 border-b">Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø³Ù‡ÙˆÙ„Ø©</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {stats.hardestQuestions.map((q, idx) => (
                                    <tr key={idx} className="border-b last:border-0">
                                        <td className="p-2 font-bold text-slate-400">{idx + 1}</td>
                                        <td className="p-2 font-bold text-slate-700">{q.question}</td>
                                        <td className="p-2 text-red-600 font-bold">{q.ease}</td>
                                    </tr>
                                    ))}
                                    {stats.hardestQuestions.length === 0 && (
                                    <tr><td colSpan="3" className="p-4 text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>
                                    )}
                                </tbody>
                                </table>
                            </div>
                        </div>

                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 print:shadow-none print:border-slate-300">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <Icons.ArrowUp />
                                Ø§Ù„Ù…ÙØ±Ø¯Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ø³Ù‡ÙˆÙ„Ø©
                                </h3>
                            </div>
                            <div className="overflow-auto max-h-64 print:max-h-none print:overflow-visible">
                                <table className="w-full text-center text-sm">
                                <thead className="bg-slate-50 text-slate-600">
                                    <tr>
                                    <th className="p-2 border-b">Ø§Ù„ØªØ±ØªÙŠØ¨</th>
                                    <th className="p-2 border-b">Ø§Ù„Ù…ÙØ±Ø¯Ø©</th>
                                    <th className="p-2 border-b">Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø³Ù‡ÙˆÙ„Ø©</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {stats.easiestQuestions.map((q, idx) => (
                                    <tr key={idx} className="border-b last:border-0">
                                        <td className="p-2 font-bold text-slate-400">{idx + 1}</td>
                                        <td className="p-2 font-bold text-slate-700">{q.question}</td>
                                        <td className="p-2 text-green-600 font-bold">{q.ease}</td>
                                    </tr>
                                    ))}
                                    {stats.easiestQuestions.length === 0 && (
                                    <tr><td colSpan="3" className="p-4 text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>
                                    )}
                                </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 print:shadow-none print:border-slate-300 print:break-inside-avoid">
                        <div className="mb-6">
                            <h3 className="text-lg font-bold text-slate-800">Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø³Ù‡ÙˆÙ„Ø©</h3>
                        </div>
                        <div className="h-80">
                            <ResponsiveContainer width="100%" height="100%">
                            <AreaChart data={stats.questionsAnalysis}>
                                <defs>
                                <linearGradient id="colorEase" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="5%" stopColor="#3B82F6" stopOpacity={0.8}/>
                                    <stop offset="95%" stopColor="#3B82F6" stopOpacity={0}/>
                                </linearGradient>
                                </defs>
                                <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                <XAxis dataKey="question" />
                                <YAxis domain={[0, 1]} />
                                <Area 
                                type="monotone" 
                                dataKey="ease" 
                                name="Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø³Ù‡ÙˆÙ„Ø©" 
                                stroke="#3B82F6" 
                                fillOpacity={1} 
                                fill="url(#colorEase)" 
                                />
                                <Area 
                                type="monotone" 
                                dataKey="difficulty" 
                                name="Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ØµØ¹ÙˆØ¨Ø©" 
                                stroke="#EF4444" 
                                fill="none" 
                                strokeDasharray="5 5" 
                                />
                            </AreaChart>
                            </ResponsiveContainer>
                        </div>
                    </div>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 print:break-inside-avoid">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 print:shadow-none print:border-slate-300">
                            <h3 className="text-lg font-bold text-slate-800 mb-4">ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¯Ø±Ø¬Ø§Øª (ÙØ¦Ø§Øª)</h3>
                            <div className="h-72">
                                <ResponsiveContainer width="100%" height="100%">
                                <BarChart data={stats.frequencyData}>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                    <XAxis dataKey="range" fontSize={12} />
                                    <YAxis allowDecimals={false} />
                                    <Bar dataKey="count" name="Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨" fill="#3B82F6" radius={[4, 4, 0, 0]}>
                                    {stats.frequencyData.map((entry, index) => (
                                        <Cell key={`cell-${index}`} fill={index % 2 === 0 ? '#3B82F6' : '#60A5FA'} />
                                    ))}
                                    </Bar>
                                </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 print:shadow-none print:border-slate-300">
                            <h3 className="text-lg font-bold text-slate-800 mb-4">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª</h3>
                            <div className="h-72">
                                <ResponsiveContainer width="100%" height="100%">
                                <PieChart>
                                    <Pie
                                    data={stats.levelData}
                                    cx="50%"
                                    cy="50%"
                                    innerRadius={60}
                                    outerRadius={90}
                                    paddingAngle={5}
                                    dataKey="value"
                                    label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
                                    >
                                    {stats.levelData.map((entry, index) => (
                                        <Cell key={`cell-${index}`} fill={entry.color} />
                                    ))}
                                    </Pie>
                                    <Legend verticalAlign="bottom" height={36} />
                                </PieChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('entry'); 
            const [studentsData, setStudentsData] = useState(initialData);
            const [maxScores, setMaxScores] = useState(initialMaxScores);
            const [examTitle, setExamTitle] = useState("ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±");

            const totalExamScore = useMemo(() => maxScores.reduce((a, b) => a + b, 0), [maxScores]);

            const handleTotalScoreChange = (newTotal) => {
                const total = parseInt(newTotal);
                if (isNaN(total)) return;

                const newMaxScores = [...maxScores];
                for (let i = 0; i < QUESTIONS_COUNT; i++) {
                    if (i < total) {
                        newMaxScores[i] = 1;
                    } else {
                        newMaxScores[i] = 0;
                    }
                }
                setMaxScores(newMaxScores);
                
                setStudentsData(prev => prev.map(student => {
                    const newStudent = { ...student };
                    for (let i = 1; i <= QUESTIONS_COUNT; i++) {
                        const qMax = newMaxScores[i-1];
                        if (newStudent[`q${i}`] > qMax) {
                            newStudent[`q${i}`] = qMax;
                        }
                    }
                    return newStudent;
                }));
            };

            const handleUpdateData = (id, key, value) => {
                setStudentsData(prev => prev.map(s => s.id === id ? { ...s, [key]: value } : s));
            };

            const handleUpdateMaxScore = (index, value) => {
                const newMaxScores = [...maxScores];
                newMaxScores[index] = value;
                setMaxScores(newMaxScores);
                
                if (value === 0) {
                    setStudentsData(prev => prev.map(student => ({ ...student, [`q${index + 1}`]: 0 })));
                } else {
                    setStudentsData(prev => prev.map(student => {
                        const currentScore = student[`q${index + 1}`];
                        if (currentScore > value) {
                            return { ...student, [`q${index + 1}`]: value };
                        }
                        return student;
                    }));
                }
            };

            const handleResetData = () => {
                if (window.confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ©.")) {
                    const resetData = studentsData.map(s => {
                        const newS = { ...s };
                        for (let i = 1; i <= QUESTIONS_COUNT; i++) {
                            newS[`q${i}`] = 0;
                        }
                        return newS;
                    });
                    setStudentsData(resetData);
                }
            };

            const handleRandomize = () => {
                const randomData = studentsData.map(s => {
                    const newS = { ...s };
                    const studentPerformance = Math.random(); 
                    
                    for (let i = 1; i <= QUESTIONS_COUNT; i++) {
                        const qMax = maxScores[i - 1];
                        
                        if (qMax === 0) {
                            newS[`q${i}`] = 0;
                            continue;
                        }

                        const scoreRatio = (studentPerformance * 0.7) + (Math.random() * 0.3);
                        let score = Math.round(scoreRatio * qMax);
                        score = Math.min(score, qMax); 
                        
                        newS[`q${i}`] = score;
                    }
                    return newS;
                });
                setStudentsData(randomData);
            };

            const handlePrint = () => {
                window.print();
            };

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-right" dir="rtl">
                    <header className="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-30 no-print">
                        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-3 w-full md:w-auto">
                                <div className="bg-blue-600 p-2 rounded-lg">
                                    <Icons.Calculator />
                                </div>
                                <div>
                                    <h1 className="text-xl font-bold">Ù†Ø¸Ø§Ù… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h1>
                                    <p className="text-xs text-slate-400">ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ (35 Ø·Ø§Ù„Ø¨)</p>
                                </div>
                            </div>

                            <div className="flex items-center gap-4 w-full md:w-auto justify-end">
                                
                                <div className="flex items-center gap-2 bg-slate-800 p-1.5 rounded-lg border border-slate-700">
                                    <span className="text-xs text-slate-400 whitespace-nowrap pl-2">Ø§Ø®ØªØ± Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ©:</span>
                                    <select 
                                        onChange={(e) => handleTotalScoreChange(e.target.value)}
                                        className="bg-slate-900 text-white text-sm font-bold rounded p-1 outline-none focus:ring-1 focus:ring-blue-500 cursor-pointer"
                                        defaultValue=""
                                    >
                                        <option value="" disabled>-- Ø§Ø®ØªØ± --</option>
                                        <option value="60">60 Ø¯Ø±Ø¬Ø© (60 Ù…ÙØ±Ø¯Ø©)</option>
                                        <option value="40">40 Ø¯Ø±Ø¬Ø© (40 Ù…ÙØ±Ø¯Ø©)</option>
                                        <option value="30">30 Ø¯Ø±Ø¬Ø© (30 Ù…ÙØ±Ø¯Ø©)</option>
                                        <option value="20">20 Ø¯Ø±Ø¬Ø© (20 Ù…ÙØ±Ø¯Ø©)</option>
                                        <option value="10">10 Ø¯Ø±Ø¬Ø§Øª (10 Ù…ÙØ±Ø¯Ø§Øª)</option>
                                    </select>
                                </div>

                                <div className="bg-slate-800 px-3 py-1.5 rounded-lg border border-slate-700 flex items-center gap-2">
                                    <span className="text-xs text-slate-400">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ:</span>
                                    <span className="font-bold text-white text-lg">{totalExamScore}</span>
                                </div>
                                
                                <div className="flex bg-slate-800 p-1 rounded-lg">
                                    <button
                                        onClick={() => setActiveTab('entry')}
                                        className={`flex items-center gap-2 px-4 py-2 rounded-md text-sm transition-all ${
                                            activeTab === 'entry' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-white'
                                        }`}
                                    >
                                        <Icons.Table />
                                        <span className="hidden sm:inline">Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</span>
                                    </button>
                                    <button
                                        onClick={() => setActiveTab('analysis')}
                                        className={`flex items-center gap-2 px-4 py-2 rounded-md text-sm transition-all ${
                                            activeTab === 'analysis' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-white'
                                        }`}
                                    >
                                        <Icons.FileText />
                                        <span className="hidden sm:inline">Ø§Ù„ØªÙ‚Ø±ÙŠØ±</span>
                                    </button>
                                </div>

                                {activeTab === 'analysis' && (
                                    <button
                                        onClick={handlePrint}
                                        className="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg shadow-sm flex items-center gap-2 transition-colors"
                                        title="Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±"
                                    >
                                        <Icons.Printer />
                                        <span className="hidden md:inline">Ø·Ø¨Ø§Ø¹Ø©</span>
                                    </button>
                                )}
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-4 md:p-6 print:p-0 print:max-w-none">
                        {activeTab === 'entry' ? (
                            <DataEntryView 
                                data={studentsData} 
                                maxScores={maxScores}
                                onUpdateData={handleUpdateData} 
                                onUpdateMaxScore={handleUpdateMaxScore}
                                onRandomize={handleRandomize}
                                onReset={handleResetData}
                                totalScore={totalExamScore}
                                examTitle={examTitle}
                                setExamTitle={setExamTitle}
                            />
                        ) : (
                            <AnalysisDashboard 
                                data={studentsData} 
                                maxScores={maxScores} 
                                totalScore={totalExamScore} 
                                examTitle={examTitle}
                            />
                        )}
                    </main>

                    {/* Footer - Credits */}
                    <footer className="bg-slate-900 border-t border-slate-800 p-4 mt-auto no-print">
                        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4 text-sm">
                            <div className="text-slate-400 flex items-center gap-2">
                                <span>ØªØµÙ…ÙŠÙ… ÙˆØªØ·ÙˆÙŠØ±:</span>
                                <span className="font-bold text-white">Ø£.Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø¨Ù† Ø®Ù„Ù Ø§Ù„Ø±ÙˆØ§Ø­ÙŠ</span>
                            </div>
                            <div className="text-slate-500 text-xs">
                                Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© {new Date().getFullYear()}
                            </div>
                        </div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>